String类可以说是在Java中使用最频繁的类了，就算是刚刚接触Java的初学者也不会陌生，因为对于Java程序来说，main方法就是使用一个String类型数组来作为参数的（String[] args）。对于这样一个频繁使用，甚至“家喻户晓”的类来说，String字符串可以有多长呢？十万字符？一百万字符？还是无限的呢？

要弄清楚String的最大长度，首先应该了解String类的内部实现。在String类中，是使用一个字符数组来维护字符序列的，其声明如下：

```
private final char value[];
```

这也就是说，String的最大长度取决于字符数组的最大长度，我们知道，在指定数组长度的时候，可以使用byte、short、char、int类型，而不能够使用long类型。这也就是说，数组的最大长度就是int类型的最大值，即0x7fffffff，十进制就是2147483647，同理，这也就是String所能容纳的最大字符数量。而且，获得String对象长度的length方法返回值是int类型的，而不是long类型的，也是因为这个原因。

```
public int length() {
    return value.length;
}
```

不过，这个最大值只是在理论上能够达到的值，在我们实际的使用中，一般情况下获得的最大长度比理论值要小。下面我们写一个最简单的程序来看。

```
package test;

/**
 * @author wupx
 * @date 2020/1/8
 */
public class StringTest {
    public static void main(String[] args) {
        char[] c = new char[Integer.MAX_VALUE];
    }
}
```


运行这个程序，在通常情况下，都会产生如下的错误：

```
Exception in thread "main" java.lang.OutOfMemoryError: Requested array size exceeds VM limit
	at test.StringTest.main(StringTest.java:9)
```

产生这个错误的原因就是内存溢出，也就是系统无法分配这么大的内存空间所致。计算一下，一个char类型占用2字节，2147483647个char类型就是4294967294字节，这接近于4GB大小，想要申请这么一大块连续的内存空间，失败也就不足为奇了。

那么，到底我们所用的计算机能够“承受”多大的字符数组呢，这跟软件与硬件等诸多因素都有关，我们可以编写程序来获得可申请最大字符数组的近似值。

```
package test;

/**
 * @author wupx
 * @date 2020/1/8
 */
public class StringLength {
    public static void main(String[] args) {
        //最小点  
        int low = 0;
        //最大点
        int high = Integer.MAX_VALUE;
        //中间点
        int mid = (low + high) / 2;
        int max = low;
        while (low <= high) {
            //为了确保可以申请成功，这里尝试申请10次。
            for (int i = 1; i <= 10; i++) {
                try {
                    char[] c = new char[mid];
                    //如果成功，将值赋值给max，继续尝试更大的申请值。
                    max = mid;
                    low = mid + 1;
                    mid = (high + low) / 2;
                    System.out.println(i + "次申请成功：" + max);
                    //申请成功后，直接跳出循环。
                    break;
                } catch (OutOfMemoryError e) {
                    //如果第10次依然申请失败，则缩小申请值。
                    if (i == 10) {
                        System.out.println("申请失败：" + mid);
                        high = mid - 1;
                        mid = (high + low) / 2;
                    }
                }
            }
        }
        System.out.println("可申请的最大值：" + max);
    }
}

```

这个程序使用的就是折半查找的算法思路，因为数组的最大值就是int类型的最大值，所以将最大点设置为Integer.MAX_VALUE（第6行），然后从该值的一半处开始尝试申请（第7行），如果申请成功，将最小点修改为中间点加1（第16行），并且重新计算中间点（第17行），继续更大的长度申请。如果申请失败，则将最大点修改为中间点减1（第25行）并重新计算中间点（第26行），进行稍小长度的申请。该循环重复进行，直到最小点大于最大点为止（第9行）。

由于软硬件等诸多原因，程序在不同计算机上的运行结果会有所不同，甚至在同一台计算机上，根据开发环境，当前计算机可用内存大小等原因，也可能会有所不同。在笔者的机器上，运行结果如下：

```
申请失败：1073741823
1次申请成功：536870911
申请失败：805306367
1次申请成功：671088639
申请失败：738197503
1次申请成功：704643071
申请失败：721420287
申请失败：713031679
申请失败：708837375
1次申请成功：706740223
1次申请成功：707788799
1次申请成功：708313087
申请失败：708575231
申请失败：708444159
申请失败：708378623
1次申请成功：708345855
1次申请成功：708362239
申请失败：708370431
申请失败：708366335
申请失败：708364287
申请失败：708363263
1次申请成功：708362751
申请失败：708363007
申请失败：708362879
1次申请成功：708362815
申请失败：708362847
1次申请成功：708362831
申请失败：708362839
1次申请成功：708362835
申请失败：708362837
1次申请成功：708362836
可申请的最大值：708362836
```

程序可申请的最大字符数组长度为708362836，但这是否说明，计算机可申请的最大字符数组就是这个长度呢？也不是的。因为我们到目前为止，使用的都是默认的Java堆大小。

我们知道，Java中的对象是分配在堆上的，堆的大小直接决定我们所能创建对象的多少，堆越大，所能创建的对象也就越多。因此，我们只要改变堆的大小，就可以改变所能创建对象的数量。

在我的 IDEA 中，设置的默认的最大堆的大小为 2G，以刚才的结果来说，在最大为 2G 空间的堆上运行程序，我们可以申请到字符数组的最大长度大约为 708362836。我们可以使用-Xmx来设置这个最大堆大小，进而就可以改变可申请的数组长度。例如，我们在命令行上输入：

```
java -Xmx3G test.StringLength
```

这样，就将最大Java堆空间设置为3GB，这样设置后，运行结果如下：

```
申请失败：1073741823
1次申请成功：536870911
1次申请成功：805306367
1次申请成功：939524095
1次申请成功：1006632959
1次申请成功：1040187391
1次申请成功：1056964607
1次申请成功：1065353215
1次申请成功：1069547519
1次申请成功：1071644671
1次申请成功：1072693247
1次申请成功：1073217535
申请失败：1073479679
申请失败：1073348607
申请失败：1073283071
1次申请成功：1073250303
1次申请成功：1073266687
申请失败：1073274879
申请失败：1073270783
申请失败：1073268735
申请失败：1073267711
1次申请成功：1073267199
申请失败：1073267455
申请失败：1073267327
1次申请成功：1073267263
申请失败：1073267295
申请失败：1073267279
1次申请成功：1073267271
1次申请成功：1073267275
申请失败：1073267277
1次申请成功：1073267276
可申请的最大值：1073267276
```

我们省略了运行结果的中间部分，可以看出，比起刚才的 708362836，这次所能申请的最大字符数组长度明显增大了。在理想的情况下（CUP、操作系统、内存大小等各种软硬/件都支持），只要我们将最大Java堆设置得足够大，就可以申请到最大的字符长度，即Integer.MAX_VALUE。

再次将最大Java堆空间设置为4GB：

```
java -Xmx4G test.StringLength
```

这样设置后，运行结果如下：

```
1次申请成功：1073741823
```

# 总结

在 String 类内部，是使用一个字符数组（char[]）来维护字符序列的。

String 的最大长度也就是字符数组的最大长度，理论上最大长度为 int 类型的最大值，即 2147483647。在实际中，一般可获取的最大值小于理论最大值。

由于计算机当前可用内存大小、分配等诸多原因，计算可申请的最大值的方式，结果也只是一个近似值，而不是完全地准确。